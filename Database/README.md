# ACID

컴퓨터 과학에서 ACID(Atomicity, Consistency, Isolation, Durability)란, 오류나 전원 장애 등의 경우에도 **유효성(validity)**을 보장하기 위한 **데이터베이스 트랜잭션의 속성**들을 말한다. ACID 속성을 충족시키는 일련의 데이터베이스 작업(단일 논리 연산으로 인식될 수 있음)을 트랜잭션이라고 부른다.

- 원자성(Atomicity) : 트랜잭션은 흔히 여러 개의 구문으로 구성되지만, 원자성은 트랜잭션을 단 하나의 유닛으로 취급하는 걸 보장한다. 따라서 트랜잭션은 완전히 성공하든지 완전히 실패하게 된다. 따라서 트랜잭션을 이루는 구문 중 하나라도 실패한다면 트랜잭션 전체는 실패하게 되며 데이터베이스는 바뀌지 않는다. 
- 일관성(Consistency) : 데이터베이스에 입력되는 모든 데이터는 기존에 세워진 규칙들을 지켜야 한다.
- 고립성(Isolation) : 트랜잭션은 흔히 동시적으로 수행된다. 고립성이란 동시적으로 트랜잭션을 수행한 결과가 순차적으로 트랜잭션을 수행한 결과와 같은 것을 보장한다. 고립성의 주요 목표는 [동시성 제어](https://en.wikipedia.org/wiki/Concurrency_control)이다. 완료되지 않은 트랜잭션은 다른 트랜잭션이 볼 수 없다.
- 지속성(Durability) : 성공적으로 수행된 트랜잭션은 영원히 반영되어야 한다.

## 예제

```sql
CREATE TABLE acidtest (A INTEGER, B INTEGER, CHECK(A + B = 100));
```

### 원자성 실패

### 일관성 실패

일관성은 데이터가 모든 유효성 규칙을 준수하는 걸 요구한다. 예를 들어 B는 그대로 둔 채 A에서 10을 뺐다고 가정해보자. 트랜잭션이 성공적으로 뺄셈에 성공했다면 원자성은 달성된다. 하지만 유효성 검사를 해보면 A + B = 90 인 것이 발견되며, 이는 데이터베이스의 규칙과는 비일관적이다. 그렇다면 전체 트랜잭션은 취소 돼야 하며 영향을 받은 행들은 트랜잭션 이전 상태로 롤백 돼야 한다.

### 고립성 실패

2개의 트랜잭션이 동시에 수행되고 있으며 같은 데이터를 수정하려 한다고 가정해보자. 고립성을 지키고자 한다면 하나가 완료되기까지 나머지 하나는 기다려야 한다.

T1은 A에게서 10을 가져와 B에게 주려한다. T2는 B에게서 10을 가져와 A에게 주려한다. 총 4개의 행동이 있다.

- T1이 A에서 10을 뺀다.

- T1이 B에게 10을 더한다.

- T2이 B에서 10을 뺀다.

- T2이 A에게 10을 더한다.

  이 작업들이 순서대로 수행된다면 고립성은 지켜지지만 T2가 기다려야 한다. 만약 T1이 중간에 실패한다면(2번째 단계) T1이 데이터베이스에 끼친 영향은 제거되며 T2는 유효한 데이터를 보게 된다.

---

트랜잭션을 인터리빙한다면, 실제 수행 순서는 다음이 될 수 있다.

- T1이 A에서 10을 뺀다.
- T2이 B에서 10을 뺀다.
- T2이 A에게 10을 더한다.
- T1이 B에게 10을 더한다.

T1이 중간에 실패하는 상황(4번째 단계)을 다시 고려해보자. T1이 실패하는 시점에 이미 T2는 A를 수정했다. 

## 구현

### Locking vs multiversioning

많은 데이터베이스가 ACID를 보장하기 위해 락(lock)에 의존한다. 락이란 트랜잭션이 액세스하는 데이터에 표시(mark)를 해서 다른 트랜잭션이 그 데이터를 수정하지 못하게 하는 것이다. 트랜잭션은 읽기 포함 데이터를 처리하기 전에 락을 획득해야 한다. 중요한 트랜잭션은 많은 수의 락을 요구하므로, 엄청난 오버헤드를 발생시키며 다른 트랜잭션들을 차단한다.

Multiversion concurrency control은 데이터베이스가 읽기 트랜잭션에게 수정되기 전의 데이터를 제공하는 방식이다. 이에 따르면 읽기 트랜잭션은 락을 획득하지 않아도 수행할 수 있다. 다시 말해, 쓰기 트랜잭션은 읽기 트랜잭션을 차단하지 못한다.

# References

[ACID (computer science)](https://en.wikipedia.org/wiki/ACID_(computer_science))